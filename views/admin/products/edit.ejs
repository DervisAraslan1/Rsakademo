<div class="content-header">
  <h2 class="content-title">
    <i class="fas fa-edit"></i>
    Ürün Düzenle
  </h2>
  <a href="/admin/products" class="btn-furniture" style="background: #6c757d; color: white;">
    <i class="fas fa-arrow-left"></i>
    Geri Dön
  </a>
</div>

<form action="/admin/products/<%= product.id %>/update" method="POST" enctype="multipart/form-data">
  <div class="row">
    <div class="col-lg-8">
      <!-- Ürün Bilgileri -->
      <div class="card mb-4" style="border: 2px solid rgba(139, 69, 19, 0.1); border-radius: 10px;">
        <div class="card-body" style="background: rgba(247, 243, 233, 0.5);">
          <h5 class="card-title" style="color: var(--oak-brown); margin-bottom: 20px;">
            <i class="fas fa-info-circle"></i> Ürün Bilgileri
          </h5>

          <div class="mb-3">
            <label for="name" class="form-label" style="font-weight: 600; color: var(--walnut);">
              Ürün Adı <span style="color: red;">*</span>
            </label>
            <input type="text" class="form-control" id="name" name="name" required value="<%= product.name %>" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;">
          </div>

          <div class="mb-3">
            <label for="description" class="form-label" style="font-weight: 600; color: var(--walnut);">
              Açıklama
            </label>
            <textarea class="form-control" id="description" name="description" rows="5" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;"><%= product.description || '' %></textarea>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="width" class="form-label" style="font-weight: 600; color: var(--walnut);">
                Genişlik (cm)
              </label>
              <input type="number" class="form-control" id="width" name="width" step="0.1" value="<%= typeof width !== 'undefined' ? width : '' %>" placeholder="Örn: 200" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;">
            </div>

            <div class="col-md-4 mb-3">
              <label for="height" class="form-label" style="font-weight: 600; color: var(--walnut);">
                Yükseklik (cm)
              </label>
              <input type="number" class="form-control" id="height" name="height" step="0.1" value="<%= typeof height !== 'undefined' ? height : '' %>" placeholder="Örn: 150" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;">
            </div>

            <div class="col-md-4 mb-3">
              <label for="depth" class="form-label" style="font-weight: 600; color: var(--walnut);">
                Derinlik (cm)
              </label>
              <input type="number" class="form-control" id="depth" name="depth" step="0.1" value="<%= typeof depth !== 'undefined' ? depth : '' %>" placeholder="Örn: 80" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;">
            </div>
          </div>
        </div>
      </div>

      <!-- Ürün Görselleri -->
      <div class="card" style="border: 2px solid rgba(139, 69, 19, 0.1); border-radius: 10px;">
        <div class="card-body" style="background: rgba(247, 243, 233, 0.5);">
          <h5 class="card-title" style="color: var(--oak-brown); margin-bottom: 20px;">
            <i class="fas fa-images"></i> Ürün Görselleri
          </h5>

          <!-- Mevcut Görseller -->
          <% if (product.images && Array.isArray(product.images) && product.images.length> 0) { %>
          <p class="text-muted mb-3">
            <i class="fas fa-info-circle"></i> İlk resim ana resimdir. Sürükleyerek sıralamayı
            değiştirebilirsiniz.
          </p>
          <div class="row mb-3" id="sortable-images">
            <% product.images.forEach((image, index)=> { %>
            <div class="col-md-3 mb-3 image-item" data-image="<%= image %>" draggable="true">
              <div style="position: relative; cursor: move;">
                <img src="<%= image %>" alt="Product image" class="img-fluid" style="border-radius: 8px; border: <%= index === 0 ? '4px solid var(--oak-brown)' : '2px solid rgba(139, 69, 19, 0.2)' %>; box-shadow: <%= index === 0 ? '0 4px 15px rgba(139, 69, 19, 0.4)' : 'none' %>;">

                <% if (index===0) { %>
                <span class="main-badge" style="position: absolute; top: 10px; left: 10px; background: var(--oak-brown); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">
                  <i class="fas fa-star"></i> ANA RESİM
                </span>
                <% } %>

                <button type="button" class="btn btn-danger btn-sm btn-remove-image" data-image="<%= image %>" style="position: absolute; top: 10px; right: 10px;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            <% }) %>
          </div>
          <input type="hidden" name="removed_images" id="removed_images" value="">
          <input type="hidden" name="images_order" id="images_order" value="">
          <% } else { %>
          <p class="text-muted">Henüz görsel eklenmemiş</p>
          <% } %>

          <!-- Yeni Görsel Ekle -->
          <div class="mb-3">
            <label for="images" class="form-label" style="font-weight: 600; color: var(--walnut);">
              Yeni Görseller Ekle (En fazla 5 adet)
            </label>
            <input type="file" class="form-control" id="images" name="images" multiple accept="image/*" style="border: 2px solid rgba(139, 69, 19, 0.2); border-radius: 8px;">
            <small class="text-muted">JPG, PNG veya WebP formatında yükleyebilirsiniz.</small>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <!-- Kategoriler -->
      <div class="card mb-4" style="border: 2px solid rgba(139, 69, 19, 0.1); border-radius: 10px;">
        <div class="card-body" style="background: rgba(247, 243, 233, 0.5);">
          <h5 class="card-title" style="color: var(--oak-brown); margin-bottom: 20px;">
            <i class="fas fa-tags"></i> Kategoriler <span style="color: red;">*</span>
          </h5>

          <% if (categories && categories.length> 0) { %>
          <div id="category-selection">
            <% const selectedCategoryIds=product.categories ? product.categories.map(c=> c.id) : [];
                                %>
            <% categories.forEach(category=> { %>
            <div class="form-check mb-2">
              <input class="form-check-input category-checkbox" type="checkbox" name="categories" value="<%= category.id %>" id="cat-<%= category.id %>" <%=selectedCategoryIds.includes(category.id) ? 'checked' : '' %>>
              <label class="form-check-label" for="cat-<%= category.id %>" style="font-weight: 500;">
                <%= category.name %>
              </label>
            </div>
            <% }) %>
          </div>
          <small class="text-danger d-none" id="category-error">En az bir kategori seçmelisiniz!</small>
          <% } else { %>
          <p class="text-muted">Henüz kategori yok</p>
          <a href="/admin/categories/create" class="btn btn-sm btn-outline-primary">
            Kategori Ekle
          </a>
          <% } %>
        </div>
      </div>

      <div class="card mb-4" style="border: 2px solid rgba(139, 69, 19, 0.1); border-radius: 10px;">
        <div class="card-body" style="background: rgba(247, 243, 233, 0.5);">
          <h5 class="card-title" style="color: var(--oak-brown); margin-bottom: 20px;">
            <i class="fas fa-toggle-on"></i> Ürün Durumu
          </h5>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="active" name="active" style="width: 3em; height: 1.5em; cursor: pointer;" <%= product.active === 1 ? 'checked' : '' %>>
            <label class="form-check-label" for="active" style="font-weight: 500; margin-left: 10px;">
              <span id="active-label">
                <%= product.active === 1 ? 'Aktif' : 'Pasif' %>
              </span>
            </label>
          </div>
          <small class="text-muted d-block mt-2">
            <i class="fas fa-info-circle"></i>
            Pasif ürünler sitede görünmez
          </small>
        </div>
      </div>

      <!-- Butonlar -->
      <div class="d-grid gap-2">
        <button type="submit" class="btn-furniture btn-primary-furniture" style="width: 100%; justify-content: center;">
          <i class="fas fa-save"></i>
          Değişiklikleri Kaydet
        </button>
        <a href="/admin/products" class="btn-furniture" style="background: #6c757d; color: white; justify-content: center;">
          <i class="fas fa-times"></i>
          İptal
        </a>
      </div>
    </div>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const categoryCheckboxes = document.querySelectorAll('.category-checkbox');
    const categoryError = document.getElementById('category-error');
    const removedImages = [];

    // Kategori validation
    form.addEventListener('submit', function(e) {
      const isAnyCategoryChecked = Array.from(categoryCheckboxes).some(cb => cb.checked);

      if (!isAnyCategoryChecked) {
        e.preventDefault();
        categoryError.classList.remove('d-none');
        document.getElementById('category-selection').scrollIntoView({
          behavior: 'smooth',
          block: 'center'
        });
        return false;
      }

      categoryError.classList.add('d-none');
      updateImagesOrder();
      document.getElementById('removed_images').value = JSON.stringify(removedImages);
    });

    categoryCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        if (Array.from(categoryCheckboxes).some(cb => cb.checked)) {
          categoryError.classList.add('d-none');
        }
      });
    });

    // ===== RESİM SİLME =====
    document.querySelectorAll('.btn-remove-image').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const imageUrl = this.getAttribute('data-image');

        if (confirm('Bu görseli silmek istediğinizden emin misiniz?')) {
          removedImages.push(imageUrl);
          this.closest('.image-item').remove();
          updateMainImageBadge();

          if (document.querySelectorAll('.image-item').length === 0) {
            document.getElementById('sortable-images').innerHTML =
              '<p class="text-muted col-12">Henüz görsel eklenmemiş</p>';
          }
        }
      });
    });

    // ===== SÜRÜKLE-BIRAK SIRALAMA (DÜZELTİLMİŞ) =====
    const sortableContainer = document.getElementById('sortable-images');
    if (sortableContainer) {
      let draggedItem = null;

      sortableContainer.addEventListener('dragstart', function(e) {
        const item = e.target.closest('.image-item');
        if (item) {
          draggedItem = item;
          setTimeout(() => {
            item.style.opacity = '0.5';
          }, 0);
        }
      });

      sortableContainer.addEventListener('dragend', function(e) {
        const item = e.target.closest('.image-item');
        if (item) {
          item.style.opacity = '1';
          updateMainImageBadge();
        }
      });

      sortableContainer.addEventListener('dragover', function(e) {
        e.preventDefault();

        const afterElement = getDragAfterElement(sortableContainer, e.clientX);

        if (draggedItem && afterElement == null) {
          sortableContainer.appendChild(draggedItem);
        } else if (draggedItem && afterElement) {
          sortableContainer.insertBefore(draggedItem, afterElement);
        }
      });

      function getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('.image-item:not([style*="opacity: 0.5"])')];

        return draggableElements.reduce((closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = x - box.left - box.width / 2;

          if (offset < 0 && offset > closest.offset) {
            return {
              offset: offset,
              element: child
            };
          } else {
            return closest;
          }
        }, {
          offset: Number.NEGATIVE_INFINITY
        }).element;
      }
    }

    function updateMainImageBadge() {
      const items = document.querySelectorAll('.image-item');
      items.forEach((item, index) => {
        const img = item.querySelector('img');
        let badge = item.querySelector('.main-badge');

        if (index === 0) {
          img.style.border = '4px solid var(--oak-brown)';
          img.style.boxShadow = '0 4px 15px rgba(139, 69, 19, 0.4)';
          if (!badge) {
            badge = document.createElement('span');
            badge.className = 'main-badge';
            badge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: var(--oak-brown); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; z-index: 10;';
            badge.innerHTML = '<i class="fas fa-star"></i> ANA RESİM';
            item.querySelector('div').appendChild(badge);
          }
        } else {
          img.style.border = '2px solid rgba(139, 69, 19, 0.2)';
          img.style.boxShadow = 'none';
          if (badge) {
            badge.remove();
          }
        }
      });
    }

    function updateImagesOrder() {
      const items = document.querySelectorAll('.image-item');
      const order = Array.from(items).map(item => item.getAttribute('data-image'));
      document.getElementById('images_order').value = JSON.stringify(order);
      console.log('Images order:', order);
    }

    const activeSwitch = document.getElementById('active');
    const activeLabel = document.getElementById('active-label');

    if (activeSwitch) {
      activeSwitch.addEventListener('change', function() {
        activeLabel.textContent = this.checked ? 'Aktif' : 'Pasif';
        activeLabel.style.color = this.checked ? '#28a745' : '#6c757d';
      });

      activeLabel.style.color = activeSwitch.checked ? '#28a745' : '#6c757d';
    }
  });
</script>